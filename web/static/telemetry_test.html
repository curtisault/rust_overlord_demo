<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telemetry Test - LiveView</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #0056b3;
        }

        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            font-family: monospace;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>

    <!-- Simple OpenTelemetry-like implementation for testing -->
    <script>
        // Mock OpenTelemetry implementation for testing
        window.opentelemetry = {
            trace: {
                getTracer: function(name, version) {
                    return {
                        startSpan: function(name, options) {
                            const span = {
                                name: name,
                                startTime: Date.now(),
                                attributes: options?.attributes || {},

                                setAttributes: function(attrs) {
                                    Object.assign(this.attributes, attrs);
                                },

                                recordException: function(error) {
                                    this.attributes['exception.type'] = error.constructor.name;
                                    this.attributes['exception.message'] = error.message;
                                },

                                setStatus: function(status) {
                                    this.attributes['span.status.code'] = status.code;
                                    this.attributes['span.status.message'] = status.message;
                                },

                                end: function() {
                                    this.endTime = Date.now();
                                    this.duration = this.endTime - this.startTime;
                                    addToLog('üîç [OTEL SPAN] ' + this.name + ' (' + this.duration + 'ms) ' + JSON.stringify(this.attributes));
                                }
                            };
                            return span;
                        }
                    };
                }
            }
        };

        function addToLog(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateStatus(connected) {
            const status = document.getElementById('connection-status');
            if (connected) {
                status.className = 'status connected';
                status.textContent = '‚úÖ WebSocket Connected';
            } else {
                status.className = 'status disconnected';
                status.textContent = '‚ùå WebSocket Disconnected';
            }
        }

        function clearLog() {
            document.getElementById('log-area').innerHTML = '';
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>üß™ LiveView Telemetry Test</h1>
        <p>This page tests the WebSocket connection and telemetry tracking for button clicks.</p>

        <div id="connection-status" class="status disconnected">‚ùå WebSocket Disconnected</div>

        <h2>Test Actions</h2>
        <button onclick="createTask('quick')">üöÄ Create Quick Task</button>
        <button onclick="createTask('long')">‚è∞ Create Long Task</button>
        <button onclick="createTask('error')">üí• Create Error Task</button>
        <button onclick="refreshTasks()">üîÑ Refresh Tasks</button>
        <button onclick="clearLog()">üßπ Clear Log</button>

        <h2>Telemetry Log</h2>
        <div class="log-area" id="log-area">
Waiting for telemetry events...
        </div>
    </div>

    <!-- Load our WebSocket telemetry module -->
    <script src="/app.js"></script>

    <script>
        // Override console methods to display in our log area
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        console.log = function(...args) {
            addToLog(args.join(' '));
            originalConsoleLog.apply(console, args);
        };

        console.error = function(...args) {
            addToLog('‚ùå ERROR: ' + args.join(' '));
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            addToLog('‚ö†Ô∏è WARNING: ' + args.join(' '));
            originalConsoleWarn.apply(console, args);
        };

        // Monitor WebSocket connection status
        let wsCheckInterval = setInterval(() => {
            if (window.ws) {
                updateStatus(window.ws.readyState === WebSocket.OPEN);
            }
        }, 1000);

        addToLog('üöÄ Telemetry test page loaded');
    </script>
</body>
</html>
